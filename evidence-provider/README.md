# Evidence Provider Service

The Evidence Provider runs inside the Confidential VM (Intel TDX) alongside the workload. It exposes REST endpoints that bind hardware quotes, workload metadata, and infrastructure state to a caller-supplied 64-byte challenge. This document describes the HTTP interface, request/response payloads, and expected behaviour for each endpoint.

## API Overview

| Method | Path                       | Purpose                                                             |
| ------ | -------------------------- | ------------------------------------------------------------------- |
| `POST` | `/evidence/tdx-quote`      | Return the Intel TDX quote bound to the supplied challenge.         |
| `POST` | `/evidence/workload`       | Return runtime container and image metadata bound to the challenge. |
| `POST` | `/evidence/infrastructure` | Return cloud infrastructure provenance data bound to the challenge. |
| `GET`  | `/`                        | Liveness/health check.                                              |
| `GET`  | `/metrics`                 | Prometheus metrics exposition.                                      |
| `GET`  | `/debug/pprof/*`           | Go pprof handlers (development only).                               |

All evidence endpoints require the caller to generate a 64-byte random challenge, base64-encode it, and include it in the request body. The challenge is verified and echoed back in `reportData` fields inside the response payloads, enabling freshness enforcement.

### Shared Request Schema

```jsonc
{
  // Base64-encoded 64-byte challenge generated by the Relying Application.
  "challenge": "Qk1nQ2h6b2J4b2d6b2J4Qk1nQ2h6b2J4b2d6b2J4Qk1nQ2h6b2J4b2d6b2J4Qk1nQ2h6b2J4b2d6b2J4Qk1n2g=="
}
```

### POST /evidence/tdx-quote

**Purpose:** Produce an Intel TDX quote that cryptographically binds the current CVM state and the caller-provided challenge.

**Request:** Shared schema above.

**Response:**

```jsonc
{
    "status": "success",
    "data": {
        "quote": {
            "header": { "teeType": 129, "qeSvn": "AAA=", ... },
            "tdQuoteBody": {
                "mrTd": "...",
                "reportData": "Qk1n...==",
                "rtmrs": [ "..." ]
            },
            "signedData": { "signature": "...", "certificationData": { ... } }
        }
    }
}
```

- `200 OK` when the quote is generated successfully.
- `400 Bad Request` for malformed JSON or invalid challenge length/encoding.
- `500 Internal Server Error` if the TDX module fails to return a quote.

### POST /evidence/workload

**Purpose:** Retrieve metadata about the containers and images running inside the CVM, enabling workload integrity verification.

**Request:** Shared schema above.

**Response:**

```jsonc
{
  "status": "success",
  "data": {
    "containers": [
      {
        "id": "03e3f866...",
        "name": "llm-core",
        "image": "sanctuairy/llm-core:latest",
        "imageDigest": "sha256:...",
        "state": "running",
        "startedAt": "2025-06-15T09:24:50.860084243Z",
        "labels": { "org.opencontainers.image.version": "20.04" }
      }
    ],
    "images": [
      {
        "id": "sha256:78a811ac...",
        "repoTags": ["sanctuairy/llm-core:latest"],
        "repoDigests": ["sanctuairy/llm-core@sha256:..."]
      }
    ],
    "reportData": "Qk1nQ2h6b2J4b2d6...=="
  }
}
```

- `200 OK` on success.
- `400 Bad Request` for malformed JSON or invalid challenge.
- `500 Internal Server Error` if Docker metadata cannot be fetched.

### POST /evidence/infrastructure

**Purpose:** Retrieve infrastructure provenance, including GCP instance details and boot disk metadata, tied to the challenge.

**Request:** Shared schema above.

**Response:**

```jsonc
{
    "status": "success",
    "data": {
        "summary": {
            "provider": "Google Cloud Platform",
            "instanceId": "8105972874086498876",
            "name": "confidential-service-tee",
            "zone": "europe-west4-a",
            "machineType": "c3-standard-4"
        },
        "instance": { "cpuPlatform": "Intel Sapphire Rapids", ... },
        "disk": { "sourceImage": "https://www.googleapis.com/compute/...", ... },
        "reportData": "Qk1nQ2h6b2J4b2d6...=="
    }
}
```

- `200 OK` on success.
- `400 Bad Request` for malformed JSON or invalid challenge.
- `500 Internal Server Error` if GCP metadata APIs return errors.

## Error Envelope

On failure the service responds with:

```json
{
  "status": "error",
  "message": "human-readable description"
}
```

HTTP status codes reflect the error category (`400` for client issues, `500` for internal failures).

## Operational Notes

- All endpoints require HTTPS termination by the surrounding infrastructure; the service listens on HTTP port `8080` inside the CVM.
- `/metrics` exposes Prometheus counters and histograms (request duration, status codes).
- `/debug/pprof/*` is available for troubleshooting when port-forwarded to trusted operators.
